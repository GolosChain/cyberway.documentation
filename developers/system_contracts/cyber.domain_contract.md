
## Назначение смарт-контракта cyber.domain
Cмарт-контракт `cyber.domain` обеспечивает создание и обработку доменных имен, создание или удаление привязки доменных имен к аккаунтам, создание имен пользователей с привязкой к аккаунту, смену владельцев доменных имен, а также покупку доменных имен на аукционе.  

В состав смарт-контракта `cyber.domain` входят:  
  * группа операций-действий, используемых для покупки доменного имени на аукционе, в том числе: [checkwin](#checkwin), [biddomain](#biddomain), [biddmrefund](#biddmrefund) и [newdomain](#newdomain);
  * группа внутренних доменных операций-действий, в том числе: [passdomain](#passdomain), [linkdomain](#linkdomain), [unlinkdomain](#unlinkdomain) и [newusername](#newusername). Код данных операций-действий находится в ядре, но их вызов происходит через смарт-контракт;  
  * объявление используемых в транзакциях имен [declarenames](#declarenames).

## Требования, предъявляемые к доменным именам
Доменные имена в CyberWay формируются в соответствии с правилами и процедурами Domain Name System (DNS). К структуре доменных имен предъявляются следующие требования:  
  * общее количество символов в доменном имени не должно превышать 253 шт.;  
  * доменное имя состоит из отдельных *частей*, разделенных символом «точка»;  
  * наличие нахождения рядом двух символов «точка» недопустимо;  
  * количество символов в отдельной *части* доменного имени не должно превышать 63 шт.;  
  * допустимыми символами в доменном имени являются буквенно-цифровые, а также символ «дефис»;  
  * наличие прописных букв в доменном имени недопустимо;  
  * символ «дефис» не должен находиться в начале или конце любой *части* доменного имени;  
  * самая правая *часть* доменного имени должна содержать хотя бы один буквенный символ. Наличие в ней только цифр недопустимо.

## Требования, предъявляемые к именам пользователей (username)
К имени пользователя предъявляются следующие требования:  
  * общее количество символов в имени пользователя не должно превышать 32 шт.;   
  * имя пользователя может состоять из отдельных *частей*, разделенных символом «точка»;  
  * наличие нахождения рядом двух символов «точка» недопустимо;  
  * допустимыми символами в имени пользователя являются буквенно-цифровые, а также символ «дефис»;  
  * наличие прописных букв в имени пользователя недопустимо;  
  * символ «дефис» не может находиться в начале или в конце имени пользователя.  


## Аукцион доменных имен в смарт-контракте
Операции-действия [checkwin](#checkwin), [biddomain](#biddomain), [biddmrefund](#biddmrefund) и [newdomain](#newdomain) используются для покупки доменного имени на аукционе. Процедура покупки доменного имени на аукционе выполняется аналогично процедуре покупки имени аккаунта. В процедуре действуют следующие правила:  
  * ставки на покупку любого доменного имени принимаются на аукционе в любой момент;  
  * по самой крупной ставке определяется единственное доменное имя, которое может быть выкуплено в настоящий момент;  
  * доменное имя считается выкупленным на аукционе, если были выполнены следующие условия:  
    * после предыдущей ставки на данное доменное имя прошло не менее суток;
    * с момента предыдущего выкупа любого доменного имени прошло не менее суток;
  * по завершении аукциона победителю не возвращается его ставка. Победитель может воспользоваться следующими возможностями:   
    * создать самостоятельно доменное имя с использованием операции `newdomain` и стать его владельцем;  
    * владелец доменного имени может создать от него поддоменные имена добавлением к нему слева символа «точка» и части имени (например, владелец домена `golos.io` может создавать поддомены `api.golos.io`, `ws.golos.io` и т.д. При этом допускается только прямое наследование доменных имен (например, если владелец создал домен для второго уровня, то создание домена для третьего уровня будет недопустимым).  

Следует заметить, что в `cyberway` *имена аккаунтов* формируются добавлением частей **справа** (например, от `cyber` могут быть образованы `cyber.msig`, `cyber.domain`).


**Примечание:**  
  * В CyberWay имеются операции-действия, прописанные непосредственно в ядре. У этой группы операций-действий часть логики выполняется в ядре, а часть — в смарт-контракте (например, у `newaccount` создание объекта `account` и вспомогательных объектов, выделение для него памяти и выделение ресурсов `bandwidth` выполняется в ядре).

### checkwin 
Операция-действие `checkwin` используется для контроля появления владельца (победителя) доменного имени на аукционе. Данная операция не требует специального вызова и вызывается автоматически при вызове `biddomain` и `biddmrefund`.

Операция-действие `checkwin` имеет следующий вид:  
```cpp
[[eosio::action]] void checkwin();  
``` 

**Параметры:**  
Данная операция не имеет входных параметров.

Операцию может выполнить любой аккаунт. 

### biddomain
Операция-действие `biddomain` позволяет аккаунту делать ставки на аукционе для покупки доменного имени. Данная операция имеет следующий вид:  
```cpp
[[eosio::action]] void biddomain(
    name bidder,
    domain_name name,
    asset bid
);  
```
**Параметры:**  
* `bidder` — имя аккаунта, делающего ставку на аукционе на покупку доменного имени;  
* `name` — доменное имя (строковое значение в соответствии с требованиями), на которое делается ставка;   
* `bid` — ставка (структура `asset`, токен должен быть системным).

> **Примечания:**  
> * Для выполнение данной операции-действия требуется, чтобы аккаунт смарт-контракта `cyber.domain` был наделен правами аккаунта `bidder` на выполнение операции `transfer` в контракте `cyber.token`.
> * В случае, если на аукционе появляется бо́льшая ставка на то же доменное имя, осуществляется возврат предыдущей ставки аккаунту `bidder`. Возврат выполняется автоматически внутренним вызовом `biddmrefund` из `biddomain`.   

### biddmrefund  
Операция-действие `biddmrefund` используется для возврата с аукциона ставки на покупку доменного имени в случае, если для того же доменного имени была сделана ставка с бо́льшим значением. Данная операция имеет вид:  
```cpp
[[eosio::action]] void biddmrefund(
    name bidder,
    domain_name name
);  
```
**Параметры:**  
* `bidder` — имя аккаунта, которому делается возврат средств с аукциона;   
* `name` — доменное имя, на покупку которого была сделана ставка.  

В случае возникновения нестандартной ситуации (появление сбоя в сети или ошибки в работе узла) возможен вызов `biddmrefund` отдельно от вызова `biddomain` (нестандартный вызов `biddmrefund`).  


### newdomain 
Операция-действие `newdomain` используется для создания нового доменного имени. Данная операция имеет следующий вид:  
```cpp
[[eosio::action]] void newdomain(
    eosio::name creator,
    domain_name name
);
```
**Параметры:**  
* `creator` — имя аккаунта, создающего доменное имя;  
* `name` — создаваемое доменное имя.  

Операция-действие `newdomain` может быть выполнена в следующих вариантах: 
  * создание доменного имени системным аккаунтом `cyber.domain` (без аукциона);  
  * создание собственного доменного имени победителем аукциона доменных имен;  
  * создание под-доменного имени владельцем прямого родительского домена.  

Аккаунт смарт-контракта `cyber.domain` должен быть привилегированным или иметь разрешения на перевод средств с `cyber.names` (в случае возврата средств). По завершении выполнения данной операции-действия аккаунт `creator` становится владельцем созданного доменного имени.


## Операции с именами пользователя (username)

### newusername
Операция-действие `newusername` используется для создания имени пользователя и имеет следующий вид:  
```cpp
[[eosio::action]] void newusername(
    name creator,
    name owner,
    username name
); 
```
**Параметры:**    
* `creator` — имя аккаунта, в области (scope) которого создается имя пользователя;  
* `owner`— имя аккаунта, который станет владельцем имени пользователя;  
* `name` — текстовое представление имени пользователя.  

Для выполнения операции `newusername` транзакция должна быть подписана аккаунтом `creator`.  


## Операции с доменами

### passdomain  
Операция-действие `passdomain` используется для передачи доменного имени от одного аккаунта другому (для смены владельца доменного имени) и имеет следующий вид:  
```cpp
[[eosio::action]] void passdomain(
    name from,
    name to,
    domain_name name
); 
```
**Параметры:**    
* `from` — аккаунт, от которого передается доменное имя и который является его владельцем;  
* `to` — аккаунт, который получает доменное имя и станет его владельцем;  
* `name` — строковое представление передаваемого доменного имени.  

Для выполнения операции в транзакции требуется подпись аккаунта `from` — владельца доменного имени.  

### linkdomain  
Операция-действие `linkdomain` используется для привязки доменного имени к имени аккаунта. После привязки аккаунт можно найти по доменному имени вместо имени аккаунта. Объявление `linkdomain` имеет следующий вид:  

```cpp
[[eosio::action]] void linkdomain(
    name owner,
    name to,
    domain_name name
);
```  
**Параметры:**    
* `owner` — аккаунт, владелец доменного имени;  
* `to` — аккаунт, к которому привязывается доменное имя;
* `name` — строковое представление доменного имени.  

Для выполнения операции в транзакции требуется подпись аккаунта `owner`.

### unlinkdomain 
Операция-действие `unlinkdomain` используется для удаления привязки доменного имени от имени аккаунта. «Отвязанное» доменное имя не указывает на аккаунт. Объявление `unlinkdomain` имеет следующий вид:  
```cpp
[[eosio::action]] void unlinkdomain(
    name owner,
    domain_name name
);
```  
**Параметры:**    
* `owner` — аккаунт, владелец доменного имени;
* `name` — строковое представление доменного имени.  
 
### Пример использования linkdomain, unlinkdomain и newusername
Пусть аккаунту, на котором установлен контракт, присвоено трудно запоминающееся имя `ajhgsd23qw`.  
 
Для устранения этого недостатка данный аккаунт покупает доменное имя `hello` и привязывает его к своему контракту используя `linkdomain`.
 
Пользователям легче запомнить домен `@hello` и отправлять трансфер на это имя, в отличие от трансфера на имя аккаунта `ajhgsd23qw`. Доменное имя `@hello` будет разрешаться в `ajhgsd23qw`, и в транзакции будет добавлена операция-действие `declarenames` с указанием использованных доменных имен.

Для прекращения использования доменного имени `@hello` аккаунт должен вызвать операцию-действие `unlinkdomain`. После этого доменное имя `@hello` не будет разрешаться в `ajhgsd23qw` и, следовательно, отправка трансфера на домен будет невозможна.  
 
Аккаунт `ajhgsd23qw` в своем окружении может создавать имена пользователей. Например себе он берёт имя `admin`, а для контракта `cyber.token` хочет назначить короткое имя `t`. После этого имя `admin@@ajhgsd23qw` (обратите внимание на двойной `@@`) будет разрешаться в имя `ajhgsd23qw`, а `t@@ajhgsd23qw` в `cyber.token`. При добавлении доменного имени можно использовать `admin@hello` и `t@hello` соответственно.

## Объявление имён, используемых в транзакции

Для определения имени пользователя только одного доменного имени недостаточно. Имя пользователя привязывается к аккаунту-владельцу и аккаунту-области (обычно это смарт-контракт) и имеет вид структуры `имя@домен`. Доменная часть определяет область. В разных областях могут существовать аккаунты с одинаковыми именами. 
Имеются несколько синтаксисов, поддерживаемых данные `username`, которые позволяют текстовому представлению имени пользователя сопоставить имя аккаунта.  

### declarenames
Операция-действие `declarenames` используется для передачи списка структур с информацией об использованных в транзакции доменных именах (или именах пользователей) и соответствующих им аккаунтам.  
```cpp
[[eosio::action]] void declarenames(
    vector<name_info> domains
);
```

**Параметры:**  
* `domains` — массив описаний, каждое описание представляет собой структуру `name_info`.  

Операция `declarenames` может быть выполнена любым аккаунтом.   

### Описание структуры name_info
Структура `name_info` используется для проверки наличия всех элементов в момент их применения, а также наличия связи доменного имени с указанным аккаунтом. Объявление `name_info` имеет следующий вид:  

```cpp
struct name_info {
    domain_name domain;
    name account;
    vector<username> users;
};
```  
**Параметры:**  
* `domain` — доменное имя;  
* `account` — имя аккаунта, соответствующее доменному имени;  
* `users` — список имен пользователей доменного имени.  

Объявление `declarenames` принимает на вход непустой массив структур.
 
Для имен пользователей отсутствуют соответствия, так как имя пользователя, в отличие от доменного имени, в течение всего времени не меняет свой аккаунт.  

Массив `domains` должен соответствовать следующим требованиям:  
  * в списке не должно быть двух структур с одинаковым доменным именем (поле `.domain`), за исключением пустых значений (“”);  
  * структуры должны быть отсортированы по возрастанию доменного имени. Структуры с доменным именем, являющимся пустой строкой, должны быть отсортированы по имени аккаунта (поле `.account`);
  * поле `.account` не должно содержать пустое значение.  


> **Примечания:**  
>  * В настоящей реализации нет проверки, что указанные в `declarenames` аккаунты существуют в других операциях-действиях транзакции. Реализация проверки затруднена, так как непосредственно процесс проверки требует большие ресурсы, затрачиваемые на чтение файла формата ABI и десериализацию действия. Риск отсутствия такой проверки — добавление отправителем транзакции больше информации, чем ее необходимо для проверки. В результате ему нужно будет дополнительно заплатить за излишне используемые ресурсы `bandwidth`.  
>  * В настоящей реализации отсутствует информация о позициях используемых доменных или пользовательских имен.
  
### Пример 1:
Транзакция может содержать действие с несколькими именами аккаунтов в качестве аргументов, например такое:
* `someaction(name1, name2, name3, name4, name5)`

В случае, если пользователь отправит действие со следующими параметрами `someaction(acc1, one@golos, two@golos, acc1, three@golos)`, и они разрешатся в один и тот же аккаунт (`someaction(acc1, acc1, acc1, acc1, acc1)`), то `declarenames` будет содержать только используемые имена пользователей или доменные имена. При этом нельзя определить позиции, на которых были использованы имена пользователей:
```
declarenames([{
    domain:"golos",
    account:N(acc1),
    users:["one","two","three"]
}])
```

### Пример 2:
Поддержка имен вида `username@@account` (наличие символов «@@» в имени означает, что правая часть — не доменное имя, а имя аккаунта). Например, если транзакция разрешает имена вида `alice@@token`, `bob@@token`, `admin@@golos.io`, то  объявление `declarenames` будет содержать следующие аргументы:  
```
declarenames([
    {domain:"", account:N(golos.io), users:["admin"]},
    {domain:"", account:N(token), users:["alice","bob"]}
])
```

В данном случае в `declarenames` в `users` указаны использованные имена пользователей, а в `account` — области (scope), где они зарегистрированы. При этом конечные аккаунты, в которые разрешаются имена, не указаны. Но эксплорер или другое приложение всегда может определить аккаунт по паре `username`+`scope`.

